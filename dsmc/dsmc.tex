\documentclass[onlymath]{beamer}
\usepackage{fontspec}
\usepackage{xunicode,xltxtra}
\usepackage{polyglossia}
\usepackage{xltxtra}
\usepackage{fancybox}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{amsmath}
\usetikzlibrary{calc}
\usetikzlibrary{intersections}
\usetikzlibrary{decorations.pathmorphing}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{patterns}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{positioning}
\tikzset{dot/.style={circle,fill=black,scale=0.5}}
\tikzset{particle/.style={circle,fill=black,scale=0.5}}
\usepackage[auto]{contour}
\contourlength{1pt}
\contournumber{8}

\usepackage{listings}
\lstset{language=haskell, basicstyle=\scriptsize\ttfamily, escapechar=|, frame=single}

\newcommand{\abs}[1]{\left \lvert{#1}\right \rvert}
\newcommand\tw\textwidth
\newcommand\neword\emph
\newcommand\code\texttt

\newcommand\avg[1]{\left\langle{#1}\right\rangle}

\\renewcommand\geq\geqslant
\renewcommand\leq\leqslant
\newcommand{\pardiff}[2]{\frac{\partial{#1}}{\partial{#2}}}

\DeclareMathOperator\Kn{Kn}
\DeclareMathOperator\diverg{div}
\DeclareMathOperator\gradient{grad}

\renewcommand\epsilon\varepsilon
\newcommand{\cenfig}[2]{\begin{figure}\centering\includegraphics[scale=#1]{#2}
  \end{figure}}

\newcommand\good{{\color{green!50!black} \textbf{+}}}
\newcommand\bad{{\color{red!50!black} \textbf{--}}}

\usefonttheme{professionalfonts}
\usetheme[secheader]{Boadilla}
\usecolortheme{whale}

\setsansfont[Mapping=tex-text]{Myriad Pro}
\setmonofont[Mapping=tex-text]{DejaVu Sans Mono}

\setmainlanguage{russian}

\title{Прямое статистическое моделирование}
\author{Дмитрий Джус}
\institute{АК-121}
\date{25 апреля 2011}

\begin{document}

\begin{frame}
  \titlepage
\end{frame}

\begin{frame}
  \frametitle{План}
  \tableofcontents
\end{frame}

\section{Кинетическая теория газа}

\begin{frame}
  \frametitle{Простая модель одноатомного газа}
  \begin{itemize}
  \item Трёхмерное пространство с молекулами
  \item У каждой молекулы есть положение $\vec{x}(t)$ и тепловая
    скорость $\vec{c}(t)$
  \item Положения и скорости меняются от взаимодействия частиц между
    собой и действия внешних сил
  \item \textbf{Задача}: найти $\vec{x}(t)$, $\vec{c}(t)$ для частиц в
    расчётной области
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{ВИА Частицы}
  \begin{figure}
    \centering
    \begin{tikzpicture}
      \coordinate (O) at (0, 0);
      \coordinate (A) at ($ (O) + (1, 1) $);
      \coordinate (B) at ($ (O) + (-2, -0.1) $);
      \coordinate (C) at ($ (O) + (1.7, -0.5) $);
      \coordinate (D) at ($ (O) + (0.1, -1.5) $);
      \draw[ultra thick] ($ (O) + (-3, -2) $) -- ++(6, 0) -- ++(0, 4) -- ++(-6, 0) --
      ++(0, -4);

      \node[draw, shape=circle] at (A) {};
      \draw[->] (A) -- ++(0.3, 0.3);
      \node[draw, shape=circle] at (B) {};
      \draw[->] (B) -- ++(-0.4, 0.5);
      \node[draw, shape=circle] at (C) {};
      \draw[->] (C) -- ++(0.3, -0.5);
      \node[draw, shape=circle] at (D) {};
      \draw[->] (D) -- ++(0.1, 0.6);
    \end{tikzpicture}
  \end{figure}
  \begin{itemize}
  \item (в проекции на 2D)
  \item Помимо $\vec{x}$ и $\vec{c}$ у частицы могут быть другие
    степени свободы (зависит от модели)
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Макроскопические параметры}
  \begin{itemize}
  \item Микроскопические параметры отдельных молекул нам совсем не интересны
  \item Макроскопические параметры \emph{осредняют} микроскопические
    по элементарным объёмам
  \item Микроскопические параметры связаны с молекулами,
    макроскопические — с точкой в пространстве
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Макроскопические параметры (2)}
  \begin{itemize}
  \item Концентрация $n$ — количество молекул в единице объёма
    \begin{equation*}
      n = \frac{N}{V}
    \end{equation*}
  \item Плотность $\rho$ — масса на единицу объёма
    \begin{equation*}
      \rho = m n
    \end{equation*}
  \item Скорость среды $\vec{V}=\avg{\vec{c}}$ — осреднение по скоростям молекул в
    элементарном объёме
    \begin{equation*}
      \avg{\vec{c}} = \frac{1}{N}\sum_{i \in V}{\vec{c}}
    \end{equation*}
  \item Температура $T$
    \begin{equation*}
      \frac{3kT}{m} = \avg{c^2}
    \end{equation*}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Макроскопические параметры (3)}
  \begin{itemize}
  \item Компоненты тензора давления
    \begin{equation*}
      p_{ij} = \rho \avg{c_i} \avg{c_j}
    \end{equation*}
  \item Скалярный параметр давления в среде
    \begin{equation*}
      p = \frac{1}{3}\rho\avg{c^2}
    \end{equation*}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Описание эволюции ансамбля}
  \begin{itemize}
  \item Частиц в среде очень много
  \item Можно интегрировать уравнения движения для всех частиц (метод
    \emph{молекулярной динамики}) — это вычислительные сложности
  \item Больцман рассмотрел сразу \emph{ансамбли} частиц, описываемые
    \emph{статистической} функцией распределения
    \begin{equation*}
      f(\vec{x}, \vec{c}, t)
    \end{equation*}
  \item Задана в шестимерном фазовом пространстве
  \item По определению, количество частиц в элементе $d\vec{x}\,
    d\vec{c}$ равно
    \begin{equation*}
      f(\vec{x}, \vec{c}, t) \,d\vec{x}\, d\vec{c}
    \end{equation*}
    Столько частиц имеют положение в интервале от $\vec{x}$ до
    $\vec{x}+d\vec{x}$ и скорость в интервале от $\vec{c}$ до
    $\vec{c}+d\vec{c}$.
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Вычисление макроскопических параметров}
  \begin{itemize}
  \item Число частиц в единице физического объёма
    \begin{equation*}
      n(\vec{x}, t) = \int f(\vec{x}, \vec{c}, t)\,d\vec{c}
    \end{equation*}
    Интегрирование проводится по всем скоростям.
  \item По определению, средняя величина $\vec{\Phi}$ вычисляется с
    как момент функции распределения $f$
    \begin{equation*}
      \avg{\Phi} = \frac{\int{\Phi f \,d\vec{c}}}{n}
    \end{equation*}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Уравнение Больцмана}
  \begin{itemize}
  \item Описывает эволюцию ансамблей частиц
    \begin{equation*}
      \underbrace{\pardiff{f}{t} +
        \vec{c} \pardiff{f}{\vec{x}}}_{\text{изменение в фазовом
          пространстве}} +
      \underbrace{K(f)}_{\text{интеграл столкновений}} = 0
    \end{equation*}
  \item Интеграл столкновений содержит модель взаимодействия частиц
  \item Не учитываем внешние силы
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Интеграл столкновений}
  \begin{itemize}
  \item Часто используемый вид $K(f)$ для одноатомного газа
    \begin{equation*}
      \int\int\int(f'f'_1-f f_1) {c_r \sigma \,d\Omega\,d\vec{c_1}}
    \end{equation*}
    \begin{itemize}
    \item $f, f_1$ — функции распределения до столкновения
    \item $f', f'_1$ — после
    \item $c_r$ — модуль относительной скорости
    \item $\sigma$ — сечение столкновения (например, $\sigma = \pi d^2$)
    \end{itemize}
  \item Описывает столкновение двух классов молекул
  \end{itemize}
\end{frame}


\begin{frame}
  \frametitle{Полезная симметрия уравнения Больцмана}
  \begin{figure}
    \centering
      \begin{tikzpicture}[scale=0.7]
      \coordinate (O) at (0, 0);
      \coordinate (A) at ($ (O) + (1, 1) $);
      \coordinate (B) at ($ (O) + (-2, -0.1) $);
      \coordinate (C) at ($ (O) + (1.7, -0.5) $);
      \coordinate (D) at ($ (O) + (0.1, -1.5) $);
      \coordinate (E) at ($ (O) + (0.3, -0.5) $);
      \coordinate (F) at ($ (O) + (0.1, -1.5) $);
      \coordinate (G) at ($ (O) + (-1, 1.5) $);
      \coordinate (H) at ($ (O) + (-0.8, 1.0) $);

      \draw[ultra thick] ($ (O) + (-3, -2) $) -- ++(6, 0) -- ++(0, 4) -- ++(-6, 0) --
      ++(0, -4);

      \node[draw, shape=circle] at (A) {};
      \node[draw, shape=circle] at (B) {};
      \node[draw, shape=circle] at (C) {};
      \node[draw, shape=circle] at (D) {};
      \node[draw, shape=circle] at (E) {};
      \node[draw, shape=circle] at (F) {};
      \node[draw, shape=circle] at (G) {};
      \node[draw, shape=circle] at (H) {};

      \coordinate (O') at (7, 0);
      \coordinate (A') at ($ (O') + (1, 1) $);
      \coordinate (B') at ($ (O') + (-2, -0.1) $);
      \coordinate (D') at ($ (O') + (0.1, -1.5) $);
      \draw[ultra thick] ($ (O') + (-3, -2) $) -- ++(6, 0) -- ++(0, 4) -- ++(-6, 0) --
      ++(0, -4);

      \node[draw, shape=circle, scale=1.5] at (A') {};
      \node[draw, shape=circle, scale=1.5] at (B') {};
      \node[draw, shape=circle, scale=1.5] at (D') {};
    \end{tikzpicture}
  \end{figure}
  \begin{itemize}
  \item Важная величина из $K(f)$ — частота столкновений $\nu = n
    \sigma \avg{c_r}$
  \item Если в двух ансамблях $n_1 \sigma_1 = n_2 \sigma_2$, то
    частота столкновений одинакова
  \item Поэтому большое количество частиц со статистическим весом $1$
    можно \emph{моделировать} меньшим количеством «депутатов» с весом $W$
  \item Например, $n = 10^{21}$, $W = 10^{15}$ — нужно $10^6$
    депутатов
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Распределение Максвелла—Больцмана}
  \begin{itemize}
  \item Решение уравнения Больцмана для равновесного газа
    \begin{equation*}
      f_{\vec{c}}(c_x, c_y, c_z) = \left(\frac{m}{2\pi k T}\right)^{3/2}
      \exp\left[ \frac{-m(c_x^2 + c_y^2 + c_z^2)}{2kT} \right]
    \end{equation*}
  \item Параметры — $m, T$, возможно $\vec{V}$.
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Решение уравнения Больцмана}
  \begin{itemize}
  \item 6-мерное уравнение в частных производных
  \item Сложность в задании граничных условий
  \item Даже на модельных задач получаются интегро-дифференциальные
    уравнения, которые в итоге всё равно нужно решать численно
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Уравнения сплошной среды}

  \begin{itemize}
  \item Уравнения для моментов функции распределения
    $\int\Phi(\vec{c}) f \,d\vec{c}$ приводят к известным уравнениям
    сплошной среды
    \begin{equation*}
      \begin{cases}
        \frac{d\rho}{dt} = -\rho \diverg {\vec{V}},\\
        \frac{d\vec{V}}{dt} = -\frac{1}{\rho}\gradient{p} + \frac{\lambda
          + \mu}{\rho}\gradient\diverg\vec{V} + \nu\Delta\vec{V},\\
        \rho\frac{de}{dt} = -p\diverg\vec{V}+\sum_{i,j}{\Pi_{ij}\pardiff{V_i}{x_j}}-\diverg\vec{W}
      \end{cases}
    \end{equation*}
  \item Вектор потока тепла $\vec{W}$ и тензор напряжений связаны с
    $\vec{V}$ и $T$
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Число Кнудсена}

  \begin{itemize}
  \item Характеризует степень разреженности газового потока:
    \begin{equation*}
      \Kn = \frac{\lambda}{L}
    \end{equation*}
    \begin{itemize}
    \item $\lambda$ — длина свободного пробега частиц
    \item $L$ — характерный размер \emph{локальной} области
      неоднородности (градиента макропараметров):
      \begin{equation*}
        L = \frac{\rho}{d\rho / dx}
      \end{equation*}
    \end{itemize}

  \item При $\Kn \to 0$ (в практике $\Kn < 0.1$) действует основное
    предположение МСС о континуальности среды
  \item При $0.1 < \Kn < 1$ требуется уже кинетическое моделирование
  \item При $\Kn \gg 1$ (в практике $\Kn \geq 1$) столкновения молекул
    между собой не учитываются (свободномолекулярное течение)
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{На распутье}
  \begin{itemize}
  \item Пройден путь от молекулярной динамики к уравнению Больцмана и
    к континуальной модели
  \item Как же делать расчёт в разреженных газах?
  \item Околоземная орбита, микроструктуры — там $Kn > 0.1$
    (разреженная среда, либо маленькие линейные размеры тела)
  \end{itemize}
\end{frame}

\section{Прямое статистическое моделирование}
\begin{frame}
  \frametitle{Общие положения}
  \begin{itemize}
  \item Хотим смоделировать обтекание тела газовым потоком с $0.1 <
    \Kn < 1$
  \item Имитируем поведение частиц, описанное уравнением Больцмана
  \item Расщепление:
    \begin{enumerate}
      \item бесстолкновительное движение, изменяющее их положение (лагранжев этап)
      \item столкновение между частицами, изменяющее их скорости (эйлеров этап)
    \end{enumerate}
  \item Как молекулярная динамика, только взаимодействия учитываются
    стохастически
  \item Одна модельная частица симулирует $W$ реальных для правильной
    частоты столкновений
  \item Считаем, что взаимодействовать между собой могут лишь частицы,
    находящиеся в одной пространственной ячейке (потенциал
    взаимодействия ограничен)
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Шаги алгоритма}
  \begin{itemize}
  \item Разбиение прямоугольной расчётной области на ячейки (регулярная
    сетка)
  \item Первоначально в области нет молекул
  \item Итерация на каждом временном шаге $\Delta t$ состоит из
    нескольких этапов
    \begin{enumerate}
    \item Розыгрыш новых частиц на границах расчётной области по
      параметрам набегающего потока
    \item Движение частиц в пространстве и учёт условий непротекания
    \item Удаление частиц, вышедших за пределы расчётной области
    \item Сортировка частиц по ячейкам
    \item Розыгрыш столкновений внутри каждой ячейки
    \end{enumerate}
  \item По полученному распределению частиц в расчётной области
    вычисляются макропараметры потока в окрестности тела
  \item Моделирование заканчивается при установлении режима течения
    (макропараметры или $N$)
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Сетка}
  \begin{itemize}
  \item Используем регулярную сетку с заданными шагами по $x, y, z$
  \item Сетка используется для розыгрыша столкновений и для
    макропараметров
  \end{itemize}
  \begin{figure}
    \centering
    \includegraphics[scale=0.4]{grid.png}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Свободные границы}
  \begin{enumerate}
  \item На 6 гранях $\Omega$ строим объёмные источники, в которых
    разыгрываем частицы по Больцману-Максвеллу по $m, T, \vec{V}, n$
  \item Новые частицы добавляются к массиву имеющихся
  \item Многие не доживут до следующей итерации
  \end{enumerate}
\end{frame}

\begin{frame}
  \frametitle{Объёмные источники}
  \begin{figure}
    \centering
    \includegraphics[scale=0.2]{iface.png}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Движение молекул в пространстве}
  \begin{itemize}
  \item Положение каждой частицы на $i$-м шаге преобразуется по закону
    \begin{equation*}
      \vec{x}_i = \vec{x}_{i-1} + \vec{c}_{i-1} \Delta t
    \end{equation*}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Учёт граничных условий}
  \begin{itemize}
  \item Если оказалось, что частица столкнулась с телом, возвращаем её
    в точку столкновения и разыгрываем столкновение с телом
  \item Для розыгрыша нужно знать:
    \begin{itemize}
      \item координаты точки столкновения
      \item вектор нормали $\vec{n}$ к телу в точке столкновения
    \end{itemize}
  \item Тела сложные — что делать?
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Описание сложных тел}
  \begin{figure}
    \centering
    \includegraphics[scale=0.15]{csg.png}
  \end{figure}
  \begin{itemize}
  \item Используем подход CSG — конструктивная твердотельная геометрия
  \item Тело является рекурсивной композицией примитивов или других
    тел
    \begin{equation}
      B_\Sigma = (B_1 \cap B_2) \cup \overline{B_3}
    \end{equation}
  \item Примитивы — сфера, цилиндр, полупространство и другие
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Учёт столкновений со сложным телом}

\begin{itemize}
\item Вводим для частицы и тела функцию $\tau(P, B)$, которая
  возвращает набор отрезков на оси $t$, соответствующих участку
  траектории частицы внутри тела («след частицы на теле»)
  \end{itemize}
  \begin{figure}
    \centering
    \begin{tikzpicture}[scale=0.75]
      \begin{scope}
        \coordinate (O) at (0, 0);
        \coordinate (p) at ($ (O) + (120:2) $);
        \draw[name path=body, draw] (O) to[out=90, in=180] ++(45:5)
        to[out=0, in=25] ++(-75:7)
        node[label=below:$B$] {}
        to[out=205, in=-10] ++(110:4)
        to[out=170, in=-90] (O);

        \draw[name path=ray, thick, densely dotted, ->] (p) -- ++(155:1) -- ++(-25:11);
        \begin{scope}[name intersections={of=body and ray, by={a,b,c,d}}]
          \draw[ultra thick] (a) -- (d);
          \draw[ultra thick] (c) -- (b);
          \node at ($(a) + (240:0.5)$) {\contour{white}{$(t_1, \vec{n}_1)$}};
          \node at ($(d) + (90:0.5)$) {\contour{white}{$(t_2, \vec{n}_2)$}};
          \node at ($(c) + (90:0.4)$) {\contour{white}{$(t_3, \vec{n}_3)$}};
          \node at ($(b) + (90:0.5)$) {\contour{white}{$(t_4, \vec{n}_4)$}};
          \node[particle, label=below:$P$] at (p) {};

          \draw[->] (a) -- ++(165:0.5);
          \draw[->] (d) -- ++(-70:0.5);
          \draw[->] (c) -- ++(179:0.5);
          \draw[->] (b) -- ++(-20:0.5);
        \end{scope}
      \end{scope}
    \end{tikzpicture}
\end{figure}
\end{frame}

\begin{frame}
  \frametitle{Расчёт точки столкновения}
  \begin{itemize}
  \item Для каждого примитива CSG-дерева строим след частицы на нём
    (уравнение от $t$)
  \item Объединяем следы по рекурсивным правилам
    \begin{itemize}
    \item $\tau(p, B_1 \cup B_2) = \tau(p, B_1) \cup \tau(p, B_2)$
    \item $\tau(p, B_1 \cap B_2) = \tau(p, B_1) \cap \tau(p, B_2)$
    \item $\tau(p, \overline{B}) = \overline{\tau(p, B)}$
    \end{itemize}
  \item Получаем итоговый след $\tau_\Sigma = \tau(p, B_\Sigma)$
  \item Если $\tau_\Sigma \cap (-\Delta t, 0) = (t_h, 0)$, то
    частица столкнулась с телом в момент времени $t_h < 0$, по
    которому можно определить и точку столкновения
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Удаление частиц}
  \begin{itemize}
  \item После инъекции и движения многие частицы могли вылететь за
    пределы $\Omega$ — удаляем их из массива имеющихся частиц
  \item Предикат для проверки вылетевших частиц
\begin{lstlisting}
xmax >= x && x >= xmin &&
ymax >= y && y >= ymin &&
zmax >= z && z >= zmin
\end{lstlisting}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{После лагранжева этапа}
  \begin{figure}
    \centering
    \includegraphics[scale=0.2]{coll.png}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Столкновение молекул между собой}
  \begin{itemize}
  \item Сортируем частицы по ячейкам: $N$ частиц в зависимости от
    своих положений распределяются по $N_c$ ячеек. В каждой $k$-й
    ячейке окажется $N_c^k$ частиц.
  \item Сталкиваются только частицы, относящиеся к одной ячейке
    \begin{figure}
      \centering
      \includegraphics[scale=0.25]{cells.png}
    \end{figure}
  \item Для каждой пары частиц $\forall i, j$ в ячейке разыгрываем вероятность
    столкновения (схема Бернулли, $O({N_c^k}^2)$) с известной частотой $\nu$
    \begin{equation*}
      P_{ij} = \frac{\nu \Delta t}{N_c^k} = \frac{W\sigma_{ij}\vec{c}_r\Delta t}{V_c}
    \end{equation*}
    \begin{itemize}
    \item $W$ — вес «депутата»
    \item $V_c$ — объём ячейки
    \item $\vec{c}_r$ — относительная скорость двух частиц
    \item $\sigma_{ij}$ — сечение столкновения, зависящее от
      используемой модели частиц
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Что происходит в ячейке}
  \begin{figure}
    \centering
    \includegraphics[scale=0.2]{sigma.png}
  \end{figure}
  \begin{itemize}
  \item Частота $\nu$ зависит от используемой модели
  \item Ищем отношение объёма цилиндра высотой $\Delta t$ и площадью
    основания $\sigma_{ij}$ к объёму всей ячейки
  \item Испытания по схеме Бернулли — частицы сталкиваются, если
    \begin{equation*}
      P_{ij} > R[0,1]
    \end{equation*}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Что происходит в ячейке — трактовка}
  \begin{itemize}
  \item В пределах каждой ячейки эволюционирует $3 N_c^k$-координатный
    марковский процесс столкновения частиц с заданной частотой
  \item На эйлеровом этапе моделируется поведение внутри $N_c$ ячеек,
    а значит $N_c$ марковских процессов
  \item Процессы не зависят друг от друга
  \item Моделирование выполняется параллельно (у каждого процесса свой
    генератор случайных чисел)
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Модели частиц}
  \begin{itemize}
  \item Определяет:
    \begin{itemize}
    \item частоту столкновений $\nu(\sigma)$
    \item модель взаимодействия частиц (что
      происходит со скоростями после столкновения?)
    \end{itemize}
  \item Модель твёрдых сфер:
    \begin{itemize}
    \item $\sigma = \pi d^2$
    \item Вектор $\vec{c}_r$ после столкновения распределён по
      направлениями \emph{равномерно}
    \item Скорости после столкновения:
      \begin{equation*}
        \begin{cases}
          \vec{c}' = \vec{c} + [(\vec{c_1} - \vec{c})\vec{c}_r]\vec{c}_r,\\
          \vec{c}'_1 = \vec{c}_1 + [(\vec{c_1} - \vec{c})\vec{c}_r]\vec{c}_r
        \end{cases}
      \end{equation*}
    \end{itemize}
  \item Есть модели с учётом при взаимодействии внутренней энергии и
    другие
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Модели поверхности}
  \begin{itemize}
  \item Определяет взаимодействие частиц с поверхностью
  \item Модель зеркального отражения:
    \begin{itemize}
    \item Молекула отскакивает от поверхности, как бильярдный шарик
    \item $\vec{c}' = \vec{c} - 2\vec{n}(\vec{n} \cdot\vec{v})$
    \end{itemize}
  \item Есть модели диффузного отражения, с учётом температур и другие
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Вычисление макропараметров}
  \begin{itemize}
  \item Действуем по определению
  \item Разбиение области на ячейки, осреднение параметров частиц в
    каждой ячейке
  \item Результат — распределение макропараметров
  \end{itemize}
\end{frame}

\section{Реализация и результаты}

\begin{frame}[fragile]
  \frametitle{Входные данные программы}
\begin{lstlisting}
[Flow]
t = 300

n = 1e20
fn = 1e14

m = 29

velocity = (1000, 0, 0)

[Grid]
hx = 0.1
hy = 0.1
hz = 0.1

...
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Входные данные программы (тело)}
\begin{lstlisting}
  body = Intersection (Intersection (Intersection
         (Intersection (Intersection
       (Cone (1, 0, 0) (0, 0, 0) 0.3)
       (Plane (0, 1, 0) 3))
       (Cylinder (0.2, 0.8, 0) (0.3, 0.2, 0) 2.5))
       (Cylinder (0.5, 0.5, 0) ((-0.3), 0.2, 0) 3))
       (Cylinder (0.8, 0.2, 0) ((-0.3), 0.2, 0) 2.5))
       (Cylinder (0.5, 0, 1) ((-0.3), 0.2, 0) 4)
\end{lstlisting}

\end{frame}

\begin{frame}[fragile]
  \frametitle{Выходные данные программы}
  \begin{itemize}
  \item Текстовый формат (дальше используем какую-нибудь программу
    визуализации)
  \end{itemize}
\begin{lstlisting}
-0.95 -0.85 0.55 1019.4918599440547 0.35016376769650687 -13.604465334
-0.85 -0.85 0.55 1366.673053637682 -38.774232190222044 -185.471092957
-0.95 -0.75 0.55 1100.254884973527 -13.382653583679717 -63.7551895773
-0.85 -0.75 0.55 1363.7316003289795 7.254925630713765 -37.85531177083
...
\end{lstlisting}
\end{frame}

\begin{frame}[fragile,fragile]
  \frametitle{Параллелизм}
  \begin{itemize}
  \item Основная идея: если есть набор данных и чистая функция, то
    функция может применятся параллельно (\emph{Repa} +
    \emph{parallel})
\begin{lstlisting}
parMap :: (a -> b) -> [a] -> [b]
\end{lstlisting}
Рантайм сам распределяет задачи по имеющимся потокам (ядрам).
  \item Наши наборы данных — вектор частиц, либо вектор ячеек
\begin{lstlisting}
type Particle = (Point, Vec3)
type Ensemble = R.Array R.U R.DIM1 Particle
advance :: Monad m => Time -> Body -> Ensemble -> m Ensemble
\end{lstlisting}
\begin{lstlisting}
parMap rpar (\(d, s) -> pureSpawnParticles d flow s) $
                        zip [d1, d2, d3, d4, d5, d6]
                            [s1, s2, s3, s4, s5, s6]
\end{lstlisting}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Анализ данных}
  \begin{itemize}
  \item \good{} Добавление молекул (до шести потоков для каждого
    объёмного источника)
  \item \bad{} Естественный барьер (объединение векторов)
  \item \good{} Движение молекул и столкновения с телом
  \item \good{} Удаление молекул
  \item \bad{} Естественный барьер (сортировка молекул по ячейкам)
  \item \good{} Столкновения в разных ячейках
  \item Нужны некорреллированные генераторы случайных чисел на каждую ячейку
  \item \good{} Расчёт макроскопических параметров в каждой ячейке
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Результаты}
  \begin{itemize}
  \item Геометрия на рисунке построена в Paraview
  \item Сложные тела, аргон, $T = 300K, \vec{V} = (1200, 0, 0), m =
    21, n = 10^{21}, W = 10^{15}, \Delta t = 10^{-6}$
  \end{itemize}
  \begin{figure}
    \centering
    \includegraphics[scale=0.2]{b1.png}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Результаты (2)}
  \begin{figure}
    \centering
    \includegraphics[scale=0.2]{b2.png}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Результаты (3)}
  \begin{figure}
    \centering
    \includegraphics[scale=0.2]{b3.png}
  \end{figure}
\end{frame}

\begin{frame}
  \frametitle{Результаты (4)}
  \begin{figure}
    \centering
    \includegraphics[scale=0.2]{b4.png}
  \end{figure}
\end{frame}

\end{document}
